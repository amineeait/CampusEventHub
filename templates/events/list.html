{% extends "layout.html" %}

{% block title %}Events - Campus Event Management{% endblock %}

{% block content %}
  <div class="container py-5">
    <div class="row mb-4">
      <div class="col-md-8">
        <h1 class="mb-3">Campus Events</h1>
      </div>
      <div class="col-md-4 text-md-end">
        {% if current_user.is_authenticated and (current_user.is_organizer() or current_user.is_admin()) %}
          <a href="{{ url_for('create_event') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Create New Event
          </a>
        {% endif %}
      </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <form id="event-search-form" class="row g-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" id="query" name="query" placeholder="Search events..." value="{{ query }}">
            </div>
          </div>
          
          <div class="col-md-4">
            <select class="form-select" id="category" name="category">
              <option value="">All Categories</option>
              {% for category in categories %}
                <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>{{ category }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Upcoming Events -->
    <h2 class="mb-3">Upcoming Events</h2>
    {% if upcoming_events %}
      <div class="row">
        {% for event in upcoming_events %}
          <div class="col-md-4 mb-4">
            <div class="card event-card shadow-sm h-100">
              {% if event.poster %}
                <img src="{{ url_for('static', filename=event.poster) }}" class="card-img-top event-image" alt="{{ event.title }}">
              {% else %}
                <img src="https://pixabay.com/get/g10437133c29aa5bbe88100155bd2682a5ca69020b8af6c2719e5cbb867e13b91ec9ec5198a80d788d0d7899c47f8e3f194e38442941077a604bbb901a30a62da_1280.jpg" class="card-img-top event-image" alt="{{ event.title }}">
              {% endif %}
              <div class="card-body">
                <span class="badge bg-primary mb-2">{{ event.category }}</span>
                <h5 class="card-title">{{ event.title }}</h5>
                <p class="card-text text-muted">
                  <i class="fas fa-calendar-alt me-2"></i> {{ event.start_time|format_datetime('%b %d, %Y') }}<br>
                  <i class="fas fa-clock me-2"></i> {{ event.start_time|format_datetime('%I:%M %p') }} - {{ event.end_time|format_datetime('%I:%M %p') }}<br>
                  <i class="fas fa-map-marker-alt me-2"></i> {{ event.location }}
                </p>
                {% if event.max_participants %}
                  <p class="card-text">
                    <small class="text-muted">
                      <i class="fas fa-users me-1"></i> Capacity: {{ event.get_registration_count() }}/{{ event.max_participants }}
                    </small>
                  </p>
                {% endif %}
              </div>
              <div class="card-footer bg-transparent">
                <a href="{{ url_for('event_detail', event_id=event.id) }}" class="btn btn-sm btn-outline-primary w-100">View Details</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i> No upcoming events found matching your criteria.
      </div>
    {% endif %}
    
    <!-- Past Events -->
    <h2 class="mt-5 mb-3">Past Events</h2>
    {% if past_events %}
      <div class="row">
        {% for event in past_events %}
          <div class="col-md-4 mb-4">
            <div class="card event-card shadow-sm h-100">
              {% if event.poster %}
                <img src="{{ url_for('static', filename=event.poster) }}" class="card-img-top event-image" alt="{{ event.title }}">
              {% else %}
                <img src="https://pixabay.com/get/gad7dad9ea0f4e22659bb97b106438aa95f4269db40278551ded68a8e57c838dbcb1c9f1e9834fbdc3c2132508d52ff73a9fe4c6dde9bc57e3ba7917785a05709_1280.jpg" class="card-img-top event-image" alt="{{ event.title }}">
              {% endif %}
              <div class="card-body">
                <span class="badge bg-secondary mb-2">{{ event.category }}</span>
                <h5 class="card-title">{{ event.title }}</h5>
                <p class="card-text text-muted">
                  <i class="fas fa-calendar-alt me-2"></i> {{ event.start_time|format_datetime('%b %d, %Y') }}<br>
                  <i class="fas fa-clock me-2"></i> {{ event.start_time|format_datetime('%I:%M %p') }} - {{ event.end_time|format_datetime('%I:%M %p') }}<br>
                  <i class="fas fa-map-marker-alt me-2"></i> {{ event.location }}
                </p>
                {% if event.ratings %}
                  <div class="mb-2">
                    <div class="rating-stars">
                      {% set avg_rating = event.get_average_rating() %}
                      {% for i in range(1, 6) %}
                        {% if i <= avg_rating|round(0, 'floor') %}
                          <i class="fas fa-star"></i>
                        {% elif i <= avg_rating|round(0, 'ceil') and avg_rating|round(1) >= i - 0.5 %}
                          <i class="fas fa-star-half-alt"></i>
                        {% else %}
                          <i class="far fa-star"></i>
                        {% endif %}
                      {% endfor %}
                      <small class="ms-1">{{ avg_rating|round(1) }}</small>
                    </div>
                  </div>
                {% endif %}
              </div>
              <div class="card-footer bg-transparent">
                <a href="{{ url_for('event_detail', event_id=event.id) }}" class="btn btn-sm btn-outline-secondary w-100">View Details</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i> No past events found matching your criteria.
      </div>
    {% endif %}
  </div>
{% endblock %}
